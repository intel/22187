# FPGA Tutorial: Compile Flow

| Optimized for                     | Description
---                                 |---
| OS                                | Linux* Ubuntu* 18.04; Windows* 10 or Windows* Server 2016
| Hardware                          | Intel® Programmable Acceleration Card (PAC) with Intel® Arria® 10 GX FPGA
| Software                          | Intel® oneAPI DPC++ Compiler (Beta) 

_Notice: Limited support in Windows*, Compiling for FPGA hardware is not supported in Windows*_

## Purpose
This tutorial demonstrates the most commonly used compile flow for a SYCL* FPGA program:
* **Emulation flow to verify correctness**: Compile to verify the program on the CPU emulator.
* **RTL flow to view the optimization report**: Stop early in the process of FPGA synthesis for you to analyze performance bottlenecks of your design with short turnaround time.
* **Complete hardware generation flow**: Generate FPGA hardware bitstream and link against host program.

## Emulation Flow

The emulation flow is the fastest method to verify the correctness of your code. Unlike compiling a host program, the emulation flow supports FPGA extensions, such as FPGA pipe and `fpga_reg`.

An FPGA utility header file is provided to help you easily select the FPGA emulation device.
```c++
#include <CL/sycl/intel/fpga_extensions.hpp>

intel::fpga_emulator_selector device_selector;
```

### Example: Compiling for Emulation 
1. Compile the design using the following command: 
```
dpcpp -fintelfpga src/compile_flow.cpp -o a.fpga_emu -DFPGA_EMULATOR
```
2. Run the following command to verify the correctness of the program:  
```
./a.fpga_emu
``` 


## RTL Generation Flow and Optimization Report
An FPGA compilation has two stages:
1. RTL generation, which takes minutes.
2. Intel® Quartus Prime software compile, which can take hours.

The optimization report is generated after the first stage is done. To generate RTL and the optimization report, run the following command:

```
dpcpp -fintelfpga -fsycl-link src/compile_flow.cpp -o dev_early.a -Xshardware
```
An HTML-based optimization report is generated in the `dev_early.prj/reports/report.html` directory.

### Extracting Useful Information from the HTML Report
The optimization report contains performance-related information about the design, such as the following:

* Loops information
* Estimated resource utilization
* Memory configuration
* Clustering and pipelining information

This report is a early stop-point for you to iteratively improve your design without waiting for hours for compilation to complete.


## Hardware Generation Flow
Perform the following steps:

1. Ensure that the correct device selector is chosen by using the FPGA utility header:
```c++
#include <CL/sycl/intel/fpga_extensions.hpp>

fpga_hardware_device device_selector;
```

2. Generate hardware either from the source file or the image file that is produced when you generated RTL and the optimization report:

   * To generate hardware directly from the source file, run the following command:

      ```
      dpcpp -fintelfpga src/compile_flow.cpp -o a.out -Xshardware
      ``` 
     This command also generates an optimization report when it completes the first stage of the FPGA compile.
 
   * To generate hardware from the image object generated by an RTL generation flow, run the following command:

     ```
     dpcpp -fintelfpga dev_early.a -o a.out -Xshardware
     ```

## Building the Example (Linux)

Perform the following steps:
1. Install the design into the `build` directory from the design directory by running `cmake`:

   ```
   mkdir build
   cd build
   ```

   If you are compiling for the Intel® PAC with Intel Arria® 10 GX FPGA, run `cmake` using the command:

   ```
   cmake ..
   ```

   If instead you are compiling for the Intel®; PAC with Intel Stratix®; 10 SX FPGA, run `cmake` using the command:

   ```
   cmake .. -DFPGA_BOARD=intel_s10sx_pac:pac_s10
   ```

2. Compile the design through the generated `Makefile`. The following four build targets are provided, matching the recommended development flow:

   * Compile and run for emulation (fast compile time, targets emulated FPGA device): 

      ```
      make fpga_emu
      ./compile_flow.fpga_emu 
      ```

   * Generate HTML optimization report: 
   
      ```
      make report
      ``` 
     Locate the report in the `compile_flow_report.prj/reports/report.html` directory.

   * Compile and run on FPGA hardware (longer compile time, targets FPGA device):    

     ```
     make fpga 
     ./compile_flow.fpga 
     ```

(Optional) As the above hardware compile may take several hours to complete, an Intel®; PAC with Intel Arria®; 10 GX FPGA precompiled binary can be downloaded <a href="https://software.intel.com/content/dam/develop/external/us/en/documents/compile_flow.fpga.tar.gz" download>here</a>.

## Building the Example (Windows)

Perform the following steps:
Note: `cmake` is not yet supported on Windows, a build.ninja file is provided instead. 

1. Enter source file directory.

```
cd src
```

2. Compile the design. The following four build targets are provided, matching the recommended development flow:

   * Compile and run for emulation (fast compile time, targets emulated FPGA device): 

     ```
     ninja fpga_emu
     compile_flow.fpga_emu.exe 
     ```

   * Generate HTML optimization report
   
     ```
     ninja report
     ``` 
     Locate the report in the `../src/compile_flow_report.prj/reports/report.html` directory.

     If you are targeting the Intel® PAC with Intel Stratix® 10 SX FPGA, please use the following target and find the report in `../src/compile_flow_s10_pac_report.prj/reports/report.html`.

     ```
     ninja report_s10_pac
     ```

   * **Not supported yet:**  Compile and run on FPGA hardware

## Building the Example in Third-Party Integrated Development Environments (IDEs)

You can compile and run this tutorial in the Eclipse* IDE (in Linux*) and the Visual Studio* IDE (in Windows*). For instructions, refer to the following link: [Intel® oneAPI DPC++ FPGA Workflows on Third-Party IDEs](https://software.intel.com/en-us/articles/intel-oneapi-dpcpp-fpga-workflow-on-ide)
